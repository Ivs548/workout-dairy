<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Дневник тренировок</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f0f9f0 0%, #d1f2d1 100%);
            color: #1a472a;
            padding: 10px;
            min-height: 100vh;
        }
        
        .header { 
            text-align: center; 
            margin-bottom: 10px; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        .header-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
        }
        .header h1 { 
            font-size: 1.5em; 
            color: #1a472a; 
            margin-bottom: 0;
        }
        
        .categories-grid { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        
        .category-card {
            background: white;
            border-radius: 10px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            position: relative;
        }
        
        .category-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
        .category-card.expanded { margin-bottom: 0; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .category-card.other-category { border-left: none; }
        
        .category-icon { font-size: 1.2em; margin-right: 10px; width: 30px; text-align: center; color: #27ae60; }
        .category-name { font-size: 0.9em; font-weight: 600; flex-grow: 1; }
        .category-count { font-size: 0.8em; color: #7f8c8d; background: #f8f9fa; padding: 2px 8px; border-radius: 10px; }
        .category-card.other-category .category-count { background: #fef7b9; color: #1a472a; font-weight: normal; }
        .category-arrow { color: #7f8c8d; font-size: 0.9em; margin-left: 8px; transition: transform 0.3s; }
        .category-card.other-category .category-arrow { display: none; }
        .category-card.expanded .category-arrow { transform: rotate(180deg); }
        
        .category-exercises {
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
            margin-top: -2px;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .category-exercises.show { display: flex; }
        
        .category-exercise-item {
            background: white;
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid #27ae60;
        }
        
        .category-exercise-item.other-category-item { border-left: 3px solid #fef7b9; background: #fffef5; }
        .category-exercise-item:hover { transform: translateX(5px); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .category-exercise-name { font-size: 0.9em; font-weight: 500; flex-grow: 1; }
        .category-exercise-stats { font-size: 0.8em; color: #7f8c8d; background: #f8f9fa; padding: 2px 8px; border-radius: 10px; }
        
        /* Навигация */
        .tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            background: white;
            padding: 8px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .tab {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: #7f8c8d;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .tab[data-tab="home"] i { color: #27ae60; }
        .tab[data-tab="home"].active i { color: white; }
        
        .tab-content { display: none; margin-bottom: 15px; }
        .tab-content.active { display: block; }
        
        /* Календарь */
        .calendar-section { margin-bottom: 15px; }
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .calendar-title { font-weight: 600; font-size: 1em; }
        .calendar-arrow {
            background: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #27ae60;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .calendar-header { text-align: center; font-size: 0.8em; color: #7f8c8d; padding: 5px 0; }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .calendar-day.has-workout { background: #27ae60; color: white; font-weight: bold; }
        .calendar-day.has-other-workout { background: #fef7b9; color: #1a472a; font-weight: bold; }
        .calendar-day.has-mixed-workouts {
            background: linear-gradient(135deg, #27ae60 0%, #27ae60 50%, #fef7b9 50%, #fef7b9 100%);
            color: white;
            font-weight: bold;
            position: relative;
        }
        .calendar-day.has-mixed-workouts { color: #1a472a; text-shadow: 0 0 2px rgba(255,255,255,0.7); }
        .calendar-day.has-mixed-workouts::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent 49%, rgba(255,255,255,0.3) 50%, transparent 51%);
        }
        .calendar-day.selected { box-shadow: 0 0 0 2px rgba(46, 204, 113, 0.3); }
        .calendar-day.empty { background: transparent; cursor: default; }
        
        /* Формы */
        .form-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .form-card h2 {
            margin-bottom: 15px;
            color: #1a472a;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-group { margin-bottom: 12px; }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border 0.3s;
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { border-color: #27ae60; outline: none; }
        #other-description:focus, #other-time:focus, #other-notes:focus { border-color: #fef7b9; }
        input[type="date"] { font-size: 0.95em; min-height: 44px; }
        .compact-input { font-size: 0.9em; padding: 10px; }
        .compact-inputs-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
        .compact-inputs-row .form-group { margin-bottom: 0; }
        .compact-inputs-row input { text-align: center; padding: 10px 5px; font-size: 0.9em; }
        .other-date-time-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .other-date-time-row .form-group { margin-bottom: 0; }
        .cardio-inputs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .hidden-field { display: none; }
        
        .btn-primary {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary.other-btn { background: linear-gradient(135deg, #fef7b9 0%, #fdf4a6 100%); color: #1a472a; border: 1px solid #f0e68c; }
        .btn-primary:active:not(:disabled) { transform: scale(0.98); }
        
        .compact-workout-card {
            background: white;
            border-radius: 10px;
            padding: 10px 12px;
            margin: 6px 0;
            position: relative;
            border-left: 4px solid #27ae60;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .compact-workout-card.other-category-card { border-left: 4px solid #fef7b9; background: #fffef5; }
        .compact-workout-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .compact-workout-name { font-size: 0.9em; font-weight: 600; color: #1a472a; flex-grow: 1; }
        .compact-workout-edit-btn {
            background: none;
            border: none;
            color: #27ae60;
            font-size: 0.85em;
            cursor: pointer;
            padding: 3px 6px;
            border-radius: 5px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .compact-workout-edit-btn:hover { background: #f0f9f0; }
        .compact-workout-delete-btn {
            background: none;
            border: none;
            color: #e74c3c;
            font-size: 0.85em;
            cursor: pointer;
            padding: 3px 6px;
            margin-left: 5px;
            border-radius: 5px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .compact-workout-delete-btn:hover { background: #ffeaea; }
        .compact-workout-stats { display: flex; justify-content: space-between; gap: 6px; margin-bottom: 6px; font-size: 0.8em; }
        .compact-workout-stat { flex: 1; text-align: center; background: #f8f9fa; padding: 4px 6px; border-radius: 6px; }
        .compact-workout-card.other-category-card .compact-workout-stat { background: #fefdf0; }
        .compact-workout-stat-label { font-size: 0.7em; color: #7f8c8d; margin-bottom: 1px; }
        .compact-workout-stat-value { font-weight: 600; color: #1a472a; font-size: 0.85em; }
        .compact-workout-difficulty { font-size: 0.75em; color: #7f8c8d; padding-top: 4px; border-top: 1px solid #f0f0f0; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 15px; }
        .stat-card-compact { background: white; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); height: 100px; display: flex; flex-direction: column; justify-content: center; }
        .stat-value-compact { font-size: 1.5em; font-weight: bold; color: #27ae60; margin-bottom: 3px; }
        .stat-label-compact { font-size: 0.8em; color: #7f8c8d; }
        .stat-date { font-size: 0.7em; color: #95a5a6; margin-top: 2px; }
        
        .day-workouts { margin-top: 15px; }
        .date-header {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .date-title { font-size: 0.95em; font-weight: bold; }
        .date-workout-count { background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 15px; font-size: 0.85em; }
        
        .day-comment { background: white; border-radius: 10px; padding: 12px; margin: 8px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .day-comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .day-comment-title { font-weight: 600; color: #1a472a; font-size: 0.9em; }
        .day-comment-edit-btn { background: none; border: none; color: #27ae60; font-size: 0.85em; cursor: pointer; padding: 3px 6px; border-radius: 5px; }
        .day-comment-text { font-size: 0.85em; color: #7f8c8d; line-height: 1.4; }
        
        .analytics-chart { background: white; border-radius: 10px; padding: 15px; margin-top: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chart-container { width: 100%; height: 180px; position: relative; margin-top: 15px; }
        .chart-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #7f8c8d; font-size: 0.85em; }
        
        .last-workout-info { background: #f8f9fa; border-radius: 8px; padding: 12px; margin-top: 15px; text-align: center; }
        .last-workout-label { font-size: 0.85em; color: #7f8c8d; margin-bottom: 5px; }
        .last-workout-value { font-size: 1.1em; font-weight: 600; color: #1a472a; }
        
        .backup-section { background: white; border-radius: 12px; padding: 20px; margin-top: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .backup-section h3 { margin-bottom: 15px; color: #1a472a; font-size: 1.1em; display: flex; align-items: center; gap: 10px; }
        .backup-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-backup {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            padding: 14px;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        .btn-backup:hover { background: #eafaf1; border-color: #27ae60; }
        .btn-backup.save { color: #27ae60; }
        .btn-backup.restore { color: #3498db; }
        .backup-info { margin-top: 10px; font-size: 0.85em; color: #7f8c8d; text-align: center; }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification.success { border-left: 4px solid #27ae60; }
        .notification.error { border-left: 4px solid #e74c3c; }
        .notification.info { border-left: 4px solid #3498db; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content { 
            background: white; 
            border-radius: 15px; 
            padding: 25px; 
            width: 90%; 
            max-width: 400px; 
            max-height: 80vh; 
            overflow-y: auto; 
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-modal { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #7f8c8d; }
        .form-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-secondary { 
            background: #95a5a6; 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 8px; 
            font-size: 1em; 
            cursor: pointer; 
            flex: 1;
            transition: opacity 0.2s;
        }
        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-secondary.other-btn { background: #fef7b9; color: #1a472a; border: 1px solid #f0e68c; }
        
        .more-btn {
            background: none;
            border: none;
            font-size: 1.2em;
            color: #7f8c8d;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.2s;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .more-btn:hover { background: rgba(0,0,0,0.05); }
        
        .dropdown-menu {
            position: absolute;
            top: 40px;
            right: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            z-index: 100;
            min-width: 100px;
            display: none;
            overflow: hidden;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item { padding: 12px 15px; display: flex; align-items: center; gap: 8px; cursor: pointer; border: none; width: 100%; background: none; font-size: 0.9em; }
        .dropdown-item:hover { background: #f8f9fa; }
        .dropdown-item.edit { color: #27ae60; }
        
        .empty-state { text-align: center; padding: 40px 20px; color: #7f8c8d; }
        .empty-state i { font-size: 3em; margin-bottom: 15px; opacity: 0.5; }
        
        @media (max-width: 768px) {
            .calendar { gap: 2px; padding: 8px; }
            .cardio-inputs, .compact-inputs-row, .other-date-time-row, .stats-grid, .backup-buttons { grid-template-columns: 1fr; }
        }
        @media (max-width: 480px) {
            .tab { width: 40px; height: 40px; font-size: 1.1em; }
            .header h1 { font-size: 1.3em; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-logo">
            <i class="fas fa-dumbbell"></i>
        </div>
        <h1>Дневник тренировок</h1>
    </div>
    
    <div id="categories-container" class="categories-grid"></div>
    
    <!-- Навигация -->
    <div class="tabs">
        <button class="tab" data-tab="catalog" title="Каталог упражнений">
            <i class="fas fa-dumbbell"></i>
        </button>
        <button class="tab active" data-tab="home" title="Главная">
            <i class="fas fa-home"></i>
        </button>
        <button class="tab" data-tab="workouts" title="Тренировки">
            <i class="fas fa-running"></i>
        </button>
        <button class="tab" data-tab="stats" title="Статистика">
            <i class="fas fa-chart-line"></i>
        </button>
        <button class="tab" data-tab="analytics" title="Аналитика">
            <i class="fas fa-chart-bar"></i>
        </button>
    </div>
    
    <!-- Контент вкладок -->
    <div class="tab-content active" id="home-tab">
        <div class="calendar-section">
            <div class="calendar-nav">
                <button class="calendar-arrow" id="prev-month">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="calendar-title" id="calendar-title"></div>
                <button class="calendar-arrow" id="next-month">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="calendar" id="calendar"></div>
        </div>
        <div id="selected-day-workouts" class="day-workouts"></div>
    </div>
    
    <div class="tab-content" id="catalog-tab">
        <div class="form-card">
            <h2><i class="fas fa-plus-circle"></i> Новое упражнение</h2>
            <div class="form-group">
                <input type="text" id="exercise-name" placeholder="Название упражнения">
            </div>
            <div class="form-group">
                <select id="exercise-category">
                    <option value="Кардио">Кардио</option>
                    <option value="Ноги и ягодицы">Ноги и ягодицы</option>
                    <option value="Руки и спина">Руки и спина</option>
                    <option value="Грудь и пресс">Грудь и пресс</option>
                    <option value="Другое" disabled>Другое (не добавляется здесь)</option>
                </select>
            </div>
            <div class="form-group">
                <textarea id="exercise-description" placeholder="Описание (необязательно)" rows="2"></textarea>
            </div>
            <button onclick="addExercise()" class="btn-primary">
                <i class="fas fa-save"></i> Сохранить упражнение
            </button>
        </div>
    </div>
    
    <div class="tab-content" id="workouts-tab">
        <div class="form-card" id="workout-form-card">
            <h2><i class="fas fa-running"></i> Новая тренировка</h2>
            <div class="form-group">
                <select id="workout-exercise">
                    <option value="">Выберите упражнение</option>
                </select>
            </div>
            <div class="form-group">
                <input type="date" id="workout-date" class="compact-input">
            </div>
            <div id="standard-fields" class="standard-inputs hidden-field">
                <div class="compact-inputs-row">
                    <div class="form-group">
                        <input type="number" id="weight" placeholder="Вес (кг)" step="0.5" min="0" class="compact-input">
                    </div>
                    <div class="form-group">
                        <input type="number" id="reps" placeholder="Повторения" min="1" class="compact-input">
                    </div>
                    <div class="form-group">
                        <input type="number" id="sets" placeholder="Подходы" min="1" class="compact-input">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 8px;">
                    <input type="text" id="difficulty" placeholder="легко/средне/тяжело" class="compact-input">
                </div>
            </div>
            <div id="cardio-fields" class="cardio-inputs hidden-field">
                <div class="compact-inputs-row">
                    <div class="form-group">
                        <input type="number" id="level" placeholder="Уровень" step="0.1" min="0" class="compact-input">
                    </div>
                    <div class="form-group">
                        <input type="number" id="distance" placeholder="Расстояние (км)" step="0.1" min="0" class="compact-input">
                    </div>
                    <div class="form-group">
                        <input type="number" id="time" placeholder="Время (мин)" step="1" min="0" class="compact-input">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 8px;">
                    <input type="text" id="cardio-difficulty" placeholder="легко/средне/тяжело" class="compact-input">
                </div>
            </div>
            <button onclick="addWorkout()" class="btn-primary" id="save-workout-btn">
                <i class="fas fa-save"></i> Сохранить тренировку
            </button>
        </div>
        
        <div class="form-card hidden-field" id="other-workout-form-card">
            <h2><i class="fas fa-plus-circle" style="color: #27ae60;"></i> Новая тренировка (Другое)</h2>
            <div class="form-group">
                <input type="text" id="other-description" placeholder="Описание тренировки *" required>
            </div>
            <div class="other-date-time-row">
                <div class="form-group">
                    <input type="date" id="other-date" class="compact-input">
                </div>
                <div class="form-group">
                    <input type="text" id="other-time" placeholder="Время (например, 30 мин)" class="compact-input">
                </div>
            </div>
            <div class="form-group">
                <textarea id="other-notes" placeholder="Примечания (необязательно)" rows="2"></textarea>
            </div>
            <button onclick="addOtherWorkout()" class="btn-primary other-btn" id="save-other-workout-btn">
                <i class="fas fa-save"></i> Сохранить тренировку
            </button>
            <button onclick="showRegularWorkoutForm()" class="btn-secondary other-btn" style="margin-top: 10px;">
                <i class="fas fa-arrow-left"></i> К обычным тренировкам
            </button>
        </div>
        
        <div class="form-card">
            <h2><i class="fas fa-history"></i> История упражнения</h2>
            <div id="exercise-history-container">
                <p style="text-align: center; color: #7f8c8d;">Выберите упражнение для просмотра истории</p>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="stats-tab">
        <div class="form-card">
            <h2><i class="fas fa-chart-line"></i> Статистика</h2>
            <div class="stats-grid">
                <div class="stat-card-compact">
                    <div class="stat-value-compact" id="total-workouts">0</div>
                    <div class="stat-label-compact">Тренировок</div>
                </div>
                <div class="stat-card-compact">
                    <div class="stat-value-compact" id="this-month">0</div>
                    <div class="stat-label-compact">В этом месяце</div>
                </div>
                <div class="stat-card-compact">
                    <div class="stat-value-compact" id="total-distance">0</div>
                    <div class="stat-label-compact">Км (кардио)</div>
                </div>
                <div class="stat-card-compact">
                    <div class="stat-value-compact" id="best-arms-back">0</div>
                    <div class="stat-label-compact">Руки и спина</div>
                    <div class="stat-date" id="best-arms-back-date">-</div>
                </div>
                <div class="stat-card-compact">
                    <div class="stat-value-compact" id="best-legs">0</div>
                    <div class="stat-label-compact">Ноги и ягодицы</div>
                    <div class="stat-date" id="best-legs-date">-</div>
                </div>
                <div class="stat-card-compact">
                    <div class="stat-value-compact" id="best-chest">0</div>
                    <div class="stat-label-compact">Грудь и пресс</div>
                    <div class="stat-date" id="best-chest-date">-</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="analytics-tab">
        <div class="form-card">
            <h2><i class="fas fa-chart-bar"></i> Аналитика</h2>
            <div class="form-group">
                <select id="analytics-exercise">
                    <option value="">Выберите упражнение для анализа</option>
                </select>
            </div>
            <div class="analytics-chart">
                <h3 style="font-size: 1em; margin-bottom: 10px;">Прогресс по упражнению</h3>
                <div class="chart-container" id="progress-chart">
                    <div class="chart-placeholder">
                        <i class="fas fa-chart-line" style="font-size: 2em; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Выберите упражнение для отображения прогресса</p>
                    </div>
                </div>
                <div id="last-workout-container" style="display: none;">
                    <div class="last-workout-info">
                        <div class="last-workout-label">Последняя тренировка</div>
                        <div class="last-workout-value" id="last-workout-value">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="backup-section">
        <h3><i class="fas fa-database"></i> Резервное копирование</h3>
        <div class="backup-buttons">
            <button onclick="createBackup()" class="btn-backup save">
                <i class="fas fa-save"></i> Создать резервную копию
            </button>
            <button onclick="restoreBackup()" class="btn-backup restore">
                <i class="fas fa-history"></i> Восстановить данные
            </button>
        </div>
        <div class="backup-info" id="backup-info">
            Последнее резервное копирование: никогда
        </div>
    </div>
    
    <!-- Модальное окно редактирования тренировки -->
    <div class="modal" id="edit-workout-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">Редактировать тренировку</h2>
                <button class="close-modal" onclick="closeEditWorkoutModal()">&times;</button>
            </div>
            <form id="edit-workout-form">
                <input type="hidden" id="edit-workout-id">
                <input type="hidden" id="edit-workout-category">
                <div class="form-group">
                    <label style="font-size: 0.9em; color: #7f8c8d; margin-bottom: 5px; display: block;">Упражнение</label>
                    <div style="font-weight: 600; padding: 10px; background: #f8f9fa; border-radius: 8px;" id="edit-workout-exercise-name"></div>
                </div>
                <div id="edit-standard-fields" class="standard-inputs hidden-field">
                    <div class="form-group">
                        <input type="date" id="edit-workout-date" class="compact-input" required>
                    </div>
                    <div class="compact-inputs-row">
                        <div class="form-group">
                            <input type="number" id="edit-weight" placeholder="Вес (кг)" step="0.5" min="0" class="compact-input" required>
                        </div>
                        <div class="form-group">
                            <input type="number" id="edit-reps" placeholder="Повторения" min="1" class="compact-input" required>
                        </div>
                        <div class="form-group">
                            <input type="number" id="edit-sets" placeholder="Подходы" min="1" class="compact-input" required>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 8px;">
                        <input type="text" id="edit-difficulty" placeholder="легко/средне/тяжело" class="compact-input">
                    </div>
                </div>
                <div id="edit-cardio-fields" class="cardio-inputs hidden-field">
                    <div class="form-group">
                        <input type="date" id="edit-cardio-date" class="compact-input" required>
                    </div>
                    <div class="compact-inputs-row">
                        <div class="form-group">
                            <input type="number" id="edit-level" placeholder="Уровень" step="0.1" min="0" class="compact-input">
                        </div>
                        <div class="form-group">
                            <input type="number" id="edit-distance" placeholder="Расстояние (км)" step="0.1" min="0" class="compact-input">
                        </div>
                        <div class="form-group">
                            <input type="number" id="edit-time" placeholder="Время (мин)" step="1" min="0" class="compact-input">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 8px;">
                        <input type="text" id="edit-cardio-difficulty" placeholder="легко/средне/тяжело" class="compact-input">
                    </div>
                </div>
                <div id="edit-other-fields" class="hidden-field">
                    <div class="form-group">
                        <input type="text" id="edit-other-description" placeholder="Описание тренировки *" required>
                    </div>
                    <div class="other-date-time-row">
                        <div class="form-group">
                            <input type="date" id="edit-other-date" class="compact-input" required>
                        </div>
                        <div class="form-group">
                            <input type="text" id="edit-other-time" placeholder="Время выполнения" class="compact-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <textarea id="edit-other-notes" placeholder="Примечания" rows="2"></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeEditWorkoutModal()" id="cancel-edit-btn">Отмена</button>
                    <button type="button" class="btn-primary" onclick="saveWorkoutChanges()" id="save-edit-btn">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Модальное окно редактирования упражнения -->
    <div class="modal" id="exercise-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">Редактировать упражнение</h2>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <form id="edit-exercise-form" onsubmit="saveExerciseChanges(event)">
                <input type="hidden" id="edit-exercise-id">
                <div class="form-group">
                    <input type="text" id="edit-exercise-name" placeholder="Название" required>
                </div>
                <div class="form-group">
                    <select id="edit-exercise-category" required>
                        <option value="Кардио">Кардио</option>
                        <option value="Ноги и ягодицы">Ноги и ягодицы</option>
                        <option value="Руки и спина">Руки и спина</option>
                        <option value="Грудь и пресс">Грудь и пресс</option>
                        <option value="Другое" disabled>Другое</option>
                    </select>
                </div>
                <div class="form-group">
                    <textarea id="edit-exercise-description" placeholder="Описание" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeExerciseModal()">Отмена</button>
                    <button type="submit" class="btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let exercises = JSON.parse(localStorage.getItem('workoutDiaryExercises')) || [];
        let workouts = JSON.parse(localStorage.getItem('workoutDiaryWorkouts')) || [];
        let dayComments = JSON.parse(localStorage.getItem('workoutDiaryDayComments')) || {};
        let currentCalendarDate = new Date();
        let selectedCalendarDate = null;
        let expandedCategories = new Set();
        let currentSelectedExerciseId = null;
        
        const backupSettings = JSON.parse(localStorage.getItem('workoutDiaryBackup')) || {
            lastBackup: null,
            reminderShown: false
        };

        const categories = [
            { id: 'Кардио', name: 'Кардио', icon: 'fa-heart-pulse' },
            { id: 'Ноги и ягодицы', name: 'Ноги и ягодицы', icon: 'fa-person-running' },
            { id: 'Руки и спина', name: 'Руки и спина', icon: 'fa-dumbbell' },
            { id: 'Грудь и пресс', name: 'Грудь и пресс', icon: 'fa-user' },
            { id: 'Другое', name: 'Другое', icon: 'fa-spa' }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const todayString = formatDateForInput(today);
            document.getElementById('workout-date').value = todayString;
            document.getElementById('other-date').value = todayString;
            
            // Проверяем и чиним данные, если нужно
            fixWorkoutDataStructure();
            
            loadCategories();
            updateExerciseDropdown();
            updateAnalyticsDropdown();
            updateStats();
            initCalendar();
            checkBackupReminder();
            setupEventListeners();
            updateBackupInfo();
            
            // Добавляем начальные данные, если их нет
            if (exercises.length === 0) {
                initializeDefaultData();
            }
        });

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForComparison(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateCompact(date) {
            const d = new Date(date);
            const day = d.getDate().toString().padStart(2, '0');
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            return `${day}.${month}`;
        }

        function initializeDefaultData() {
            exercises = [
                { id: 1, name: 'Бег на дорожке', category: 'Кардио', description: 'Беговая дорожка', createdAt: new Date().toISOString() },
                { id: 2, name: 'Приседания со штангой', category: 'Ноги и ягодицы', description: 'Базовое упражнение', createdAt: new Date().toISOString() },
                { id: 3, name: 'Жим штанги лежа', category: 'Грудь и пресс', description: 'Жим на горизонтальной скамье', createdAt: new Date().toISOString() },
                { id: 4, name: 'Тяга верхнего блока', category: 'Руки и спина', description: 'Тяга к груди', createdAt: new Date().toISOString() }
            ];
            localStorage.setItem('workoutDiaryExercises', JSON.stringify(exercises));
            loadCategories();
            updateExerciseDropdown();
            updateAnalyticsDropdown();
            updateStats();
        }

        // Функция для исправления структуры данных тренировок
        function fixWorkoutDataStructure() {
            let needsFix = false;
            
            workouts.forEach((workout, index) => {
                // Проверяем обязательные поля
                if (!workout.id) {
                    workout.id = Date.now() + index;
                    needsFix = true;
                }
                if (!workout.exerciseCategory) {
                    // Определяем категорию по упражнению или устанавливаем по умолчанию
                    const exercise = exercises.find(e => e.id === workout.exerciseId);
                    workout.exerciseCategory = exercise ? exercise.category : 'Ноги и ягодицы';
                    needsFix = true;
                }
                if (!workout.date) {
                    workout.date = formatDateForInput(new Date());
                    needsFix = true;
                }
                if (!workout.exerciseName && workout.exerciseId) {
                    const exercise = exercises.find(e => e.id === workout.exerciseId);
                    workout.exerciseName = exercise ? exercise.name : 'Неизвестное упражнение';
                    needsFix = true;
                }
            });
            
            if (needsFix) {
                localStorage.setItem('workoutDiaryWorkouts', JSON.stringify(workouts));
                console.log('Структура данных тренировок исправлена');
            }
        }

        function setupEventListeners() {
            // Обработчики вкладок
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    const tabContent = document.getElementById(`${tabId}-tab`);
                    
                    if (this.classList.contains('active') && tabContent.classList.contains('active')) {
                        this.classList.remove('active');
                        tabContent.classList.remove('active');
                        document.querySelector('.tab[data-tab="home"]').classList.add('active');
                        document.getElementById('home-tab').classList.add('active');
                    } else {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                        this.classList.add('active');
                        tabContent.classList.add('active');
                    }
                    
                    if (tabId === 'stats') updateStats();
                    if (tabId === 'workouts') loadExerciseHistory();
                    if (tabId === 'analytics') updateAnalytics();
                });
            });
            
            // Навигация календаря
            document.getElementById('prev-month').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            });
            
            document.getElementById('next-month').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            });
            
            // Изменение выбранного упражнения
            document.getElementById('workout-exercise').addEventListener('change', function() {
                const exerciseId = parseInt(this.value);
                if (exerciseId) {
                    currentSelectedExerciseId = exerciseId;
                    updateWorkoutFormFields();
                    loadExerciseHistory();
                } else {
                    currentSelectedExerciseId = null;
                }
            });
            
            document.getElementById('analytics-exercise').addEventListener('change', updateAnalytics);
            document.getElementById('close-modal').addEventListener('click', closeExerciseModal);
            
            // Клик вне выпадающих меню
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.more-btn') && !e.target.closest('.dropdown-menu')) {
                    document.querySelectorAll('.dropdown-menu.show').forEach(menu => menu.classList.remove('show'));
                }
            });
        }

        function loadCategories() {
            const container = document.getElementById('categories-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            categories.forEach(category => {
                const categoryCard = document.createElement('div');
                categoryCard.className = 'category-card';
                
                if (category.id === 'Другое') {
                    categoryCard.classList.add('other-category');
                    const otherWorkoutsCount = workouts.filter(w => w.exerciseCategory === 'Другое').length;
                    
                    categoryCard.innerHTML = `
                        <div class="category-icon">
                            <i class="fas ${category.icon}"></i>
                        </div>
                        <div class="category-name">${category.name}</div>
                        <div class="category-count">${otherWorkoutsCount}</div>
                        <div class="category-arrow">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    `;
                    
                    categoryCard.addEventListener('click', (e) => {
                        openOtherWorkoutForm();
                        e.stopPropagation();
                    });
                } else {
                    const categoryExercises = exercises.filter(exercise => exercise.category === category.id);
                    
                    if (expandedCategories.has(category.id)) {
                        categoryCard.classList.add('expanded');
                    }
                    
                    categoryCard.innerHTML = `
                        <div class="category-icon">
                            <i class="fas ${category.icon}"></i>
                        </div>
                        <div class="category-name">${category.name}</div>
                        <div class="category-count">${categoryExercises.length}</div>
                        <div class="category-arrow">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    `;
                    
                    categoryCard.addEventListener('click', (e) => {
                        if (expandedCategories.has(category.id)) {
                            expandedCategories.delete(category.id);
                        } else {
                            expandedCategories.clear();
                            expandedCategories.add(category.id);
                        }
                        loadCategories();
                        e.stopPropagation();
                    });
                }
                
                container.appendChild(categoryCard);
                
                if (category.id !== 'Другое') {
                    const exercisesContainer = document.createElement('div');
                    exercisesContainer.id = `exercises-${category.id}`;
                    exercisesContainer.className = 'category-exercises';
                    if (expandedCategories.has(category.id)) {
                        exercisesContainer.classList.add('show');
                        showCategoryExercises(category.id, exercisesContainer);
                    }
                    container.appendChild(exercisesContainer);
                }
            });
        }

        function openOtherWorkoutForm() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelector('.tab[data-tab="workouts"]').classList.add('active');
            document.getElementById('workouts-tab').classList.add('active');
            
            document.getElementById('workout-form-card').classList.add('hidden-field');
            document.getElementById('other-workout-form-card').classList.remove('hidden-field');
            
            document.getElementById('other-date').value = formatDateForInput(new Date());
            
            setTimeout(() => {
                document.getElementById('other-description').focus();
            }, 300);
        }

        function showRegularWorkoutForm() {
            document.getElementById('workout-form-card').classList.remove('hidden-field');
            document.getElementById('other-workout-form-card').classList.add('hidden-field');
        }

        function showCategoryExercises(categoryId, container) {
            const categoryExercises = exercises.filter(exercise => exercise.category === categoryId);
            
            if (categoryExercises.length === 0) {
                container.innerHTML = '<div style="padding: 10px; color: #95a5a6; font-style: italic; text-align: center;">Нет упражнений</div>';
                return;
            }
            
            container.innerHTML = '';
            
            categoryExercises.forEach(exercise => {
                const exerciseElement = document.createElement('div');
                exerciseElement.className = 'category-exercise-item';
                const latestWorkout = workouts
                    .filter(w => w.exerciseId === exercise.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                
                let statsText = 'Нет данных';
                if (latestWorkout) {
                    if (exercise.category === 'Кардио') {
                        statsText = `Уровень: ${latestWorkout.level || '0'}`;
                        if (latestWorkout.distance) statsText += `, ${latestWorkout.distance} км`;
                        if (latestWorkout.time) statsText += `, ${latestWorkout.time} мин`;
                    } else {
                        statsText = `${latestWorkout.weight || '0'} кг × ${latestWorkout.reps || '0'} / ${latestWorkout.sets || '0'}`;
                    }
                }
                
                exerciseElement.innerHTML = `
                    <div class="category-exercise-name">${exercise.name}</div>
                    <div class="category-exercise-stats">${statsText}</div>
                `;
                
                const moreBtn = document.createElement('button');
                moreBtn.className = 'more-btn';
                moreBtn.innerHTML = '⋯';
                moreBtn.style.marginLeft = '8px';
                moreBtn.onclick = (e) => {
                    e.stopPropagation();
                    showExerciseMenuInCategory(e, exercise.id);
                };
                exerciseElement.appendChild(moreBtn);
                
                const dropdown = document.createElement('div');
                dropdown.className = 'dropdown-menu';
                dropdown.id = `category-dropdown-${exercise.id}`;
                dropdown.innerHTML = `
                    <button class="dropdown-item edit" onclick="openExerciseModal(${exercise.id})">
                        <i class="fas fa-edit"></i> Редактировать
                    </button>
                `;
                exerciseElement.appendChild(dropdown);
                
                exerciseElement.addEventListener('click', (e) => {
                    if (!e.target.closest('.more-btn')) {
                        openNewWorkoutWithExercise(exercise.id);
                    }
                });
                container.appendChild(exerciseElement);
            });
        }

        function showExerciseMenuInCategory(event, exerciseId) {
            event.stopPropagation();
            const dropdown = document.getElementById(`category-dropdown-${exerciseId}`);
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                if (menu !== dropdown) menu.classList.remove('show');
            });
            dropdown.classList.toggle('show');
        }

        function openNewWorkoutWithExercise(exerciseId) {
            const exercise = exercises.find(e => e.id === exerciseId);
            if (!exercise) return;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelector('.tab[data-tab="workouts"]').classList.add('active');
            document.getElementById('workouts-tab').classList.add('active');
            
            document.getElementById('workout-exercise').value = exerciseId;
            currentSelectedExerciseId = exerciseId;
            updateWorkoutFormFields();
            loadExerciseHistory();
            showRegularWorkoutForm();
            
            setTimeout(() => {
                document.getElementById('workout-form-card').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function updateWorkoutFormFields() {
            const exerciseId = currentSelectedExerciseId;
            let selectValue = parseInt(document.getElementById('workout-exercise').value);
            const finalExerciseId = exerciseId || selectValue;
            const exercise = exercises.find(e => e.id === finalExerciseId);
            
            if (exercise) {
                if (exercise.category === 'Кардио') {
                    document.getElementById('standard-fields').classList.add('hidden-field');
                    document.getElementById('cardio-fields').classList.remove('hidden-field');
                } else {
                    document.getElementById('standard-fields').classList.remove('hidden-field');
                    document.getElementById('cardio-fields').classList.add('hidden-field');
                }
            }
        }

        function addExercise() {
            const nameInput = document.getElementById('exercise-name');
            const categorySelect = document.getElementById('exercise-category');
            const descriptionTextarea = document.getElementById('exercise-description');
            
            const name = nameInput.value.trim();
            const category = categorySelect.value;
            const description = descriptionTextarea ? descriptionTextarea.value.trim() : '';
            
            if (!name) { showNotification('Введите название упражнения', 'error'); return; }
            if (category === 'Другое') { showNotification('Упражнения категории "Другое" не добавляются здесь', 'error'); return; }
            
            const exercise = {
                id: Date.now(),
                name: name,
                category: category,
                description: description,
                createdAt: new Date().toISOString()
            };
            
            exercises.push(exercise);
            localStorage.setItem('workoutDiaryExercises', JSON.stringify(exercises));
            
            loadCategories();
            updateExerciseDropdown();
            updateAnalyticsDropdown();
            updateStats();
            
            nameInput.value = '';
            if (descriptionTextarea) descriptionTextarea.value = '';
            
            expandedCategories.clear();
            expandedCategories.add(category);
            loadCategories();
            showNotification('Упражнение добавлено', 'success');
        }

        function updateExerciseDropdown() {
            const select = document.getElementById('workout-exercise');
            if (!select) return;
            
            select.innerHTML = '<option value="">Выберите упражнение</option>';
            exercises.filter(ex => ex.category !== 'Другое').forEach(ex => {
                select.innerHTML += `<option value="${ex.id}">${ex.name}</option>`;
            });
            
            if (currentSelectedExerciseId) select.value = currentSelectedExerciseId;
        }

        function updateAnalyticsDropdown() {
            const select = document.getElementById('analytics-exercise');
            if (!select) return;
            
            select.innerHTML = '<option value="">Выберите упражнение для анализа</option>';
            exercises.filter(ex => ex.category !== 'Другое').forEach(ex => {
                select.innerHTML += `<option value="${ex.id}">${ex.name}</option>`;
            });
        }

        function addWorkout() {
            const saveBtn = document.getElementById('save-workout-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохранение...';
            
            setTimeout(() => {
                try {
                    const exerciseId = currentSelectedExerciseId;
                    let selectValue = parseInt(document.getElementById('workout-exercise').value);
                    const finalExerciseId = exerciseId || selectValue;
                    const dateInput = document.getElementById('workout-date');
                    const date = dateInput.value;
                    
                    if (!finalExerciseId || !date) { 
                        showNotification('Выберите упражнение и дату', 'error'); 
                        resetButton(saveBtn, '<i class="fas fa-save"></i> Сохранить тренировку');
                        return; 
                    }
                    
                    const exercise = exercises.find(e => e.id === finalExerciseId);
                    if (!exercise) { 
                        showNotification('Упражнение не найдено', 'error'); 
                        resetButton(saveBtn, '<i class="fas fa-save"></i> Сохранить тренировку');
                        return; 
                    }
                    
                    let workoutData = {
                        id: Date.now(),
                        exerciseId: finalExerciseId,
                        exerciseName: exercise.name,
                        exerciseCategory: exercise.category,
                        date: date
                    };
                    
                    if (exercise.category === 'Кардио') {
                        const level = document.getElementById('level').value;
                        const distance = document.getElementById('distance').value;
                        const time = document.getElementById('time').value;
                        const difficulty = document.getElementById('cardio-difficulty').value;
                        
                        workoutData.level = level ? parseFloat(level) : null;
                        workoutData.distance = distance ? parseFloat(distance) : null;
                        workoutData.time = time ? parseInt(time) : null;
                        workoutData.difficulty = difficulty || 'средне';
                        workoutData.weight = 0;
                        workoutData.reps = 0;
                        workoutData.sets = 0;
                    } else {
                        const weight = parseFloat(document.getElementById('weight').value);
                        const reps = parseInt(document.getElementById('reps').value);
                        const sets = parseInt(document.getElementById('sets').value);
                        const difficulty = document.getElementById('difficulty').value;
                        
                        if (isNaN(weight) || weight <= 0 || isNaN(reps) || reps <= 0 || isNaN(sets) || sets <= 0) {
                            showNotification('Заполните поля Вес, Повторения и Подходы', 'error');
                            resetButton(saveBtn, '<i class="fas fa-save"></i> Сохранить тренировку');
                            return;
                        }
                        
                        workoutData.weight = weight;
                        workoutData.reps = reps;
                        workoutData.sets = sets;
                        workoutData.difficulty = difficulty || 'средне';
                        workoutData.level = 0;
                        workoutData.distance = null;
                        workoutData.time = null;
                    }
                    
                    workouts.push(workoutData);
                    localStorage.setItem('workoutDiaryWorkouts', JSON.stringify(workouts));
                    
                    loadCategories();
                    updateStats();
                    renderCalendar();
                    loadExerciseHistory();
                    
                    // Очистка полей
                    ['weight', 'reps', 'sets', 'level', 'distance', 'time', 'difficulty', 'cardio-difficulty'].forEach(id => {
                        const input = document.getElementById(id);
                        if (input) input.value = '';
                    });
                    
                    document.getElementById('selected-day-workouts').innerHTML = '';
                    showNotification('Тренировка сохранена', 'success');
                    
                } catch (error) {
                    console.error('Ошибка при сохранении тренировки:', error);
                    showNotification('Ошибка при сохранении тренировки', 'error');
                } finally {
                    resetButton(saveBtn, '<i class="fas fa-save"></i> Сохранить тренировку');
                }
            }, 500);
        }

        function addOtherWorkout() {
            const saveBtn = document.getElementById('save-other-workout-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохранение...';
            
            setTimeout(() => {
                try {
                    const description = document.getElementById('other-description').value.trim();
                    const date = document.getElementById('other-date').value;
                    const time = document.getElementById('other-time').value.trim();
                    const notes = document.getElementById('other-notes').value.trim();
                    
                    if (!description) { 
                        showNotification('Введите описание тренировки', 'error'); 
                        resetButton(saveBtn, '<i class="fas fa-save"></i> Сохранить тренировку');
                        return; 
                    }
                    if (!date) { 
                        showNotification('Выберите дату', 'error'); 
                        resetButton(saveBtn, '<i class="fas fa-save"></i> Сохранить тренировку');
                        return; 
                    }
                    
                    const workoutData = {
                        id: Date.now(),
                        exerciseId: null,
                        exerciseName: description,
                        exerciseCategory: 'Другое',
                        date: date,
                        time: time,
                        notes: notes,
                        isOtherCategory: true
                    };
                    
                    workouts.push(workoutData);
                    localStorage.setItem('workoutDiaryWorkouts', JSON.stringify(workouts));
                    
                    loadCategories();
                    updateStats();
                    renderCalendar();
                    
                    // Очистка полей
                    document.getElementById('other-description').value = '';
                    document.getElementById('other-time').value = '';
                    document.getElementById('other-notes').value = '';
                    document.getElementById('other-date').value = formatDateForInput(new Date());
                    
                    document.getElementById('selected-day-workouts').innerHTML = '';
                    showNotification('Тренировка "Другое" сохранена', 'success');
                    
                } catch (error) {
                    console.error('Ошибка при сохранении тренировки "Другое":', error);
                    showNotification('Ошибка при сохранении тренировки', 'error');
                } finally {
                    resetButton(saveBtn, '<i class="fas fa-save"></i> Сохранить тренировку');
                }
            }, 500);
        }

        function resetButton(button, html) {
            button.disabled = false;
            button.innerHTML = html;
        }

        function loadExerciseHistory() {
            const container = document.getElementById('exercise-history-container');
            if (!container) return;
            
            const exerciseId = currentSelectedExerciseId;
            let selectValue = parseInt(document.getElementById('workout-exercise').value);
            const finalExerciseId = exerciseId || selectValue;
            
            if (!finalExerciseId) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Выберите упражнение для просмотра истории</p>';
                return;
            }
            
            const exercise = exercises.find(e => e.id === finalExerciseId);
            if (!exercise) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Упражнение не найдено</p>';
                return;
            }
            
            const exerciseWorkouts = workouts
                .filter(w => w.exerciseId === finalExerciseId)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);
            
            if (exerciseWorkouts.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: #7f8c8d;">
                        Нет записей о тренировках для упражнения<br>
                        <strong>${exercise.name}</strong>
                    </p>
                `;
                return;
            }
            
            let html = `<div style="margin-bottom: 15px; font-weight: 600; color: #1a472a;">${exercise.name} - последние тренировки:</div>`;
            
            exerciseWorkouts.forEach(workout => {
                const date = new Date(workout.date).toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
                
                html += `
                    <div class="compact-workout-card">
                        <div class="compact-workout-header">
                            <div class="compact-workout-name">${date}</div>
                            <button class="compact-workout-edit-btn" onclick="openEditWorkoutModal(${workout.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <div class="compact-workout-stats">
                `;
                
                if (exercise.category === 'Кардио') {
                    html += `
                        <div class="compact-workout-stat">
                            <div class="compact-workout-stat-label">Уровень</div>
                            <div class="compact-workout-stat-value">${workout.level || '-'}</div>
                        </div>
                        <div class="compact-workout-stat">
                            <div class="compact-workout-stat-label">Расстояние</div>
                            <div class="compact-workout-stat-value">${workout.distance ? workout.distance + ' км' : '-'}</div>
                        </div>
                        <div class="compact-workout-stat">
                            <div class="compact-workout-stat-label">Время</div>
                            <div class="compact-workout-stat-value">${workout.time ? workout.time + ' мин' : '-'}</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="compact-workout-stat">
                            <div class="compact-workout-stat-label">Вес</div>
                            <div class="compact-workout-stat-value">${workout.weight} кг</div>
                        </div>
                        <div class="compact-workout-stat">
                            <div class="compact-workout-stat-label">Повторения</div>
                            <div class="compact-workout-stat-value">${workout.reps}</div>
                        </div>
                        <div class="compact-workout-stat">
                            <div class="compact-workout-stat-label">Подходы</div>
                            <div class="compact-workout-stat-value">${workout.sets}</div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                        <div class="compact-workout-difficulty">${workout.difficulty || 'средне'}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function openEditWorkoutModal(workoutId) {
            const workout = workouts.find(w => w.id === workoutId);
            if (!workout) {
                showNotification('Тренировка не найдена', 'error');
                return;
            }
            
            document.getElementById('edit-workout-id').value = workout.id;
            document.getElementById('edit-workout-category').value = workout.exerciseCategory || 'Ноги и ягодицы';
            
            document.getElementById('edit-workout-exercise-name').textContent = workout.exerciseName || 'Без названия';
            
            // Скрываем все поля
            document.getElementById('edit-standard-fields').classList.add('hidden-field');
            document.getElementById('edit-cardio-fields').classList.add('hidden-field');
            document.getElementById('edit-other-fields').classList.add('hidden-field');
            
            // Заполняем поля в зависимости от категории
            if (workout.exerciseCategory === 'Другое') {
                document.getElementById('edit-other-fields').classList.remove('hidden-field');
                document.getElementById('edit-other-description').value = workout.exerciseName || '';
                document.getElementById('edit-other-date').value = workout.date || formatDateForInput(new Date());
                document.getElementById('edit-other-time').value = workout.time || '';
                document.getElementById('edit-other-notes').value = workout.notes || '';
            } else if (workout.exerciseCategory === 'Кардио') {
                document.getElementById('edit-cardio-fields').classList.remove('hidden-field');
                document.getElementById('edit-cardio-date').value = workout.date || formatDateForInput(new Date());
                document.getElementById('edit-level').value = workout.level || '';
                document.getElementById('edit-distance').value = workout.distance || '';
                document.getElementById('edit-time').value = workout.time || '';
                document.getElementById('edit-cardio-difficulty').value = workout.difficulty || 'средне';
            } else {
                document.getElementById('edit-standard-fields').classList.remove('hidden-field');
                document.getElementById('edit-workout-date').value = workout.date || formatDateForInput(new Date());
                document.getElementById('edit-weight').value = workout.weight || '';
                document.getElementById('edit-reps').value = workout.reps || '';
                document.getElementById('edit-sets').value = workout.sets || '';
                document.getElementById('edit-difficulty').value = workout.difficulty || 'средне';
            }
            
            // Открываем модальное окно
            document.getElementById('edit-workout-modal').classList.add('active');
        }

        function closeEditWorkoutModal() {
            document.getElementById('edit-workout-modal').classList.remove('active');
        }

        function saveWorkoutChanges() {
            const saveBtn = document.getElementById('save-edit-btn');
            const cancelBtn = document.getElementById('cancel-edit-btn');
            
            saveBtn.disabled = true;
            cancelBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохранение...';
            
            setTimeout(() => {
                try {
                    const workoutId = parseInt(document.getElementById('edit-workout-id').value);
                    const category = document.getElementById('edit-workout-category').value;
                    
                    const workoutIndex = workouts.findIndex(w => w.id === workoutId);
                    if (workoutIndex === -1) {
                        showNotification('Тренировка не найдена', 'error');
                        resetEditButtons(saveBtn, cancelBtn);
                        return;
                    }
                    
                    let updatedWorkout = { ...workouts[workoutIndex] };
                    
                    if (category === 'Другое') {
                        const description = document.getElementById('edit-other-description').value.trim();
                        const date = document.getElementById('edit-other-date').value;
                        const time = document.getElementById('edit-other-time').value.trim();
                        const notes = document.getElementById('edit-other-notes').value.trim();
                        
                        if (!description) { 
                            showNotification('Введите описание тренировки', 'error'); 
                            resetEditButtons(saveBtn, cancelBtn);
                            return; 
                        }
                        if (!date) { 
                            showNotification('Выберите дату', 'error'); 
                            resetEditButtons(saveBtn, cancelBtn);
                            return; 
                        }
                        
                        updatedWorkout.exerciseName = description;
                        updatedWorkout.date = date;
                        updatedWorkout.time = time;
                        updatedWorkout.notes = notes;
                        updatedWorkout.exerciseCategory = 'Другое';
                        
                    } else if (category === 'Кардио') {
                        const date = document.getElementById('edit-cardio-date').value;
                        const level = document.getElementById('edit-level').value;
                        const distance = document.getElementById('edit-distance').value;
                        const time = document.getElementById('edit-time').value;
                        const difficulty = document.getElementById('edit-cardio-difficulty').value;
                        
                        if (!date) { 
                            showNotification('Выберите дату', 'error'); 
                            resetEditButtons(saveBtn, cancelBtn);
                            return; 
                        }
                        
                        updatedWorkout.date = date;
                        updatedWorkout.level = level ? parseFloat(level) : null;
                        updatedWorkout.distance = distance ? parseFloat(distance) : null;
                        updatedWorkout.time = time ? parseInt(time) : null;
                        updatedWorkout.difficulty = difficulty || 'средне';
                        updatedWorkout.exerciseCategory = 'Кардио';
                        updatedWorkout.weight = 0;
                        updatedWorkout.reps = 0;
                        updatedWorkout.sets = 0;
                        
                    } else {
                        const date = document.getElementById('edit-workout-date').value;
                        const weight = document.getElementById('edit-weight').value;
                        const reps = document.getElementById('edit-reps').value;
                        const sets = document.getElementById('edit-sets').value;
                        const difficulty = document.getElementById('edit-difficulty').value;
                        
                        if (!date) { 
                            showNotification('Выберите дату', 'error'); 
                            resetEditButtons(saveBtn, cancelBtn);
                            return; 
                        }
                        if (!weight || !reps || !sets) { 
                            showNotification('Заполните все поля', 'error'); 
                            resetEditButtons(saveBtn, cancelBtn);
                            return; 
                        }
                        
                        updatedWorkout.date = date;
                        updatedWorkout.weight = parseFloat(weight);
                        updatedWorkout.reps = parseInt(reps);
                        updatedWorkout.sets = parseInt(sets);
                        updatedWorkout.difficulty = difficulty || 'средне';
                        updatedWorkout.exerciseCategory = category;
                        updatedWorkout.level = 0;
                        updatedWorkout.distance = null;
                        updatedWorkout.time = null;
                    }
                    
                    workouts[workoutIndex] = updatedWorkout;
                    
                    localStorage.setItem('workoutDiaryWorkouts', JSON.stringify(workouts));
                    
                    loadCategories();
                    updateStats();
                    renderCalendar();
                    loadExerciseHistory();
                    
                    if (selectedCalendarDate) {
                        showDayWorkouts(selectedCalendarDate);
                    }
                    
                    closeEditWorkoutModal();
                    showNotification('Тренировка успешно обновлена', 'success');
                    
                } catch (error) {
                    console.error('Ошибка при сохранении изменений:', error);
                    showNotification('Ошибка при сохранении изменений', 'error');
                } finally {
                    resetEditButtons(saveBtn, cancelBtn);
                }
            }, 500);
        }

        function resetEditButtons(saveBtn, cancelBtn) {
            saveBtn.disabled = false;
            cancelBtn.disabled = false;
            saveBtn.innerHTML = 'Сохранить';
        }

        function deleteOtherWorkout(workoutId) {
            if (!confirm('Удалить эту тренировку?')) return;
            
            const index = workouts.findIndex(w => w.id === workoutId);
            if (index !== -1) {
                workouts.splice(index, 1);
                localStorage.setItem('workoutDiaryWorkouts', JSON.stringify(workouts));
                loadCategories();
                updateStats();
                renderCalendar();
                if (selectedCalendarDate) showDayWorkouts(selectedCalendarDate);
                showNotification('Тренировка удалена', 'success');
            }
        }

        function openExerciseModal(id) {
            const exercise = exercises.find(e => e.id === id);
            if (exercise) {
                document.getElementById('edit-exercise-id').value = exercise.id;
                document.getElementById('edit-exercise-name').value = exercise.name;
                document.getElementById('edit-exercise-category').value = exercise.category;
                document.getElementById('edit-exercise-description').value = exercise.description || '';
                document.getElementById('exercise-modal').classList.add('active');
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => menu.classList.remove('show'));
            }
        }

        function closeExerciseModal() {
            document.getElementById('exercise-modal').classList.remove('active');
        }

        function saveExerciseChanges(event) {
            event.preventDefault();
            
            const id = parseInt(document.getElementById('edit-exercise-id').value);
            const name = document.getElementById('edit-exercise-name').value.trim();
            const category = document.getElementById('edit-exercise-category').value;
            const description = document.getElementById('edit-exercise-description').value.trim();
            
            if (!name || !category) { showNotification('Заполните название и категорию', 'error'); return; }
            
            const index = exercises.findIndex(e => e.id === id);
            if (index !== -1) {
                exercises[index] = { ...exercises[index], name, category, description };
                
                workouts.forEach(workout => {
                    if (workout.exerciseId === id) {
                        workout.exerciseCategory = category;
                    }
                });
                
                localStorage.setItem('workoutDiaryExercises', JSON.stringify(exercises));
                localStorage.setItem('workoutDiaryWorkouts', JSON.stringify(workouts));
                
                loadCategories();
                updateExerciseDropdown();
                updateAnalyticsDropdown();
                updateStats();
                loadExerciseHistory();
                closeExerciseModal();
                showNotification('Упражнение обновлено', 'success');
            }
        }

        function initCalendar() { 
            renderCalendar(); 
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const title = document.getElementById('calendar-title');
            if (!calendar || !title) return;
            
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            title.textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            let firstDayOfWeek = firstDay.getDay();
            if (firstDayOfWeek === 0) firstDayOfWeek = 6; else firstDayOfWeek--;
            
            const workoutDates = new Set();
            const otherWorkoutDates = new Set();
            workouts.forEach(workout => {
                const date = new Date(workout.date);
                const dateString = formatDateForComparison(date);
                if (workout.exerciseCategory === 'Другое') {
                    otherWorkoutDates.add(dateString);
                } else {
                    workoutDates.add(dateString);
                }
            });
            
            calendar.innerHTML = '';
            const dayNames = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            dayNames.forEach(dayName => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-header';
                dayHeader.textContent = dayName;
                calendar.appendChild(dayHeader);
            });
            
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendar.appendChild(emptyDay);
            }
            
            const daysInMonth = lastDay.getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDate = new Date(year, month, day);
                const dateString = formatDateForComparison(dayDate);
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                dayElement.dataset.date = dateString;
                
                const hasWorkout = workoutDates.has(dateString);
                const hasOtherWorkout = otherWorkoutDates.has(dateString);
                
                if (hasWorkout && hasOtherWorkout) {
                    dayElement.classList.add('has-mixed-workouts');
                } else if (hasWorkout) {
                    dayElement.classList.add('has-workout');
                } else if (hasOtherWorkout) {
                    dayElement.classList.add('has-other-workout');
                }
                
                if (selectedCalendarDate === dateString) dayElement.classList.add('selected');
                
                dayElement.addEventListener('click', () => {
                    if (selectedCalendarDate === dateString) {
                        dayElement.classList.remove('selected');
                        selectedCalendarDate = null;
                        document.getElementById('selected-day-workouts').innerHTML = '';
                    } else {
                        document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));
                        dayElement.classList.add('selected');
                        selectedCalendarDate = dateString;
                        showDayWorkouts(dateString);
                    }
                });
                calendar.appendChild(dayElement);
            }
        }

        function showDayWorkouts(date) {
            const container = document.getElementById('selected-day-workouts');
            if (!container) return;
            
            const dayWorkouts = workouts.filter(w => {
                const workoutDate = new Date(w.date);
                const workoutDateString = formatDateForComparison(workoutDate);
                return workoutDateString === date;
            });
            
            const dateObj = new Date(date);
            const formattedDate = dateObj.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                weekday: 'long'
            });
            
            let html = `
                <div class="date-header">
                    <div class="date-title">${formattedDate}</div>
                    <div class="date-workout-count">${dayWorkouts.length} упражнений</div>
                </div>
            `;
            
            const comment = dayComments[date] || '';
            html += `
                <div class="day-comment">
                    <div class="day-comment-header">
                        <div class="day-comment-title">Комментарий к дню</div>
                        <button class="day-comment-edit-btn" onclick="editDayComment('${date}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div class="day-comment-text" id="day-comment-text-${date}">${comment || 'Нет комментария'}</div>
                    <textarea id="day-comment-edit-${date}" style="display: none; width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.9em; margin-top: 10px;" rows="3" placeholder="Введите комментарий...">${comment}</textarea>
                    <div id="day-comment-actions-${date}" style="display: none; margin-top: 10px; display: flex; gap: 10px;">
                        <button onclick="saveDayComment('${date}')" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Сохранить</button>
                        <button onclick="cancelDayComment('${date}')" style="background: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Отмена</button>
                    </div>
                </div>
            `;
            
            if (dayWorkouts.length === 0) {
                html += '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Нет тренировок на этот день</p>';
            } else {
                const regularWorkouts = dayWorkouts.filter(w => w.exerciseCategory !== 'Другое');
                const otherWorkouts = dayWorkouts.filter(w => w.exerciseCategory === 'Другое');
                
                if (regularWorkouts.length > 0) {
                    html += '<div style="margin-bottom: 15px;"><strong>Обычные тренировки:</strong></div>';
                    regularWorkouts.forEach(workout => {
                        const exercise = exercises.find(e => e.id === workout.exerciseId);
                        if (!exercise) return;
                        
                        html += `
                            <div class="compact-workout-card">
                                <div class="compact-workout-header">
                                    <div class="compact-workout-name">${workout.exerciseName}</div>
                                    <button class="compact-workout-edit-btn" onclick="openEditWorkoutModal(${workout.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                                <div class="compact-workout-stats">
                        `;
                        
                        if (exercise.category === 'Кардио') {
                            html += `
                                <div class="compact-workout-stat">
                                    <div class="compact-workout-stat-label">Уровень</div>
                                    <div class="compact-workout-stat-value">${workout.level || '-'}</div>
                                </div>
                                <div class="compact-workout-stat">
                                    <div class="compact-workout-stat-label">Расстояние</div>
                                    <div class="compact-workout-stat-value">${workout.distance ? workout.distance + ' км' : '-'}</div>
                                </div>
                                <div class="compact-workout-stat">
                                    <div class="compact-workout-stat-label">Время</div>
                                    <div class="compact-workout-stat-value">${workout.time ? workout.time + ' мин' : '-'}</div>
                                </div>
                            `;
                        } else {
                            html += `
                                <div class="compact-workout-stat">
                                    <div class="compact-workout-stat-label">Вес</div>
                                    <div class="compact-workout-stat-value">${workout.weight} кг</div>
                                </div>
                                <div class="compact-workout-stat">
                                    <div class="compact-workout-stat-label">Повторения</div>
                                    <div class="compact-workout-stat-value">${workout.reps}</div>
                                </div>
                                <div class="compact-workout-stat">
                                    <div class="compact-workout-stat-label">Подходы</div>
                                    <div class="compact-workout-stat-value">${workout.sets}</div>
                                </div>
                            `;
                        }
                        
                        html += `
                                </div>
                                <div class="compact-workout-difficulty">${workout.difficulty || 'средне'}</div>
                            </div>
                        `;
                    });
                }
                
                if (otherWorkouts.length > 0) {
                    html += '<div style="margin-top: 20px; margin-bottom: 15px;"><strong style="color: #1a472a;">Тренировки "Другое":</strong></div>';
                    otherWorkouts.forEach(workout => {
                        html += `
                            <div class="compact-workout-card other-category-card">
                                <div class="compact-workout-header">
                                    <div class="compact-workout-name">${workout.exerciseName}</div>
                                    <div>
                                        <button class="compact-workout-edit-btn" onclick="openEditWorkoutModal(${workout.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="compact-workout-delete-btn" onclick="deleteOtherWorkout(${workout.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="compact-workout-stats">
                                    <div class="compact-workout-stat">
                                        <div class="compact-workout-stat-label">Дата</div>
                                        <div class="compact-workout-stat-value">${new Date(workout.date).toLocaleDateString('ru-RU', {day: 'numeric', month: 'short'})}</div>
                                    </div>
                                    <div class="compact-workout-stat">
                                        <div class="compact-workout-stat-label">Время</div>
                                        <div class="compact-workout-stat-value">${workout.time || '-'}</div>
                                    </div>
                                </div>
                                ${workout.notes ? `<div style="font-size: 0.8em; color: #7f8c8d; margin-top: 5px;">${workout.notes}</div>` : ''}
                            </div>
                        `;
                    });
                }
            }
            
            container.innerHTML = html;
        }

        function editDayComment(date) {
            document.getElementById(`day-comment-text-${date}`).style.display = 'none';
            document.getElementById(`day-comment-edit-${date}`).style.display = 'block';
            document.getElementById(`day-comment-actions-${date}`).style.display = 'flex';
        }

        function saveDayComment(date) {
            const comment = document.getElementById(`day-comment-edit-${date}`).value.trim();
            dayComments[date] = comment;
            localStorage.setItem('workoutDiaryDayComments', JSON.stringify(dayComments));
            document.getElementById(`day-comment-text-${date}`).textContent = comment || 'Нет комментария';
            document.getElementById(`day-comment-text-${date}`).style.display = 'block';
            document.getElementById(`day-comment-edit-${date}`).style.display = 'none';
            document.getElementById(`day-comment-actions-${date}`).style.display = 'none';
            showNotification('Комментарий сохранен', 'success');
        }

        function cancelDayComment(date) {
            const originalComment = dayComments[date] || '';
            document.getElementById(`day-comment-text-${date}`).style.display = 'block';
            document.getElementById(`day-comment-edit-${date}`).style.display = 'none';
            document.getElementById(`day-comment-actions-${date}`).style.display = 'none';
            document.getElementById(`day-comment-edit-${date}`).value = originalComment;
        }

        function updateStats() {
            // 1. Количество тренировок
            const totalWorkoutsElem = document.getElementById('total-workouts');
            if (totalWorkoutsElem) {
                const uniqueDates = new Set();
                workouts.filter(w => w.exerciseCategory !== 'Другое').forEach(workout => {
                    const date = new Date(workout.date);
                    const dateString = formatDateForComparison(date);
                    uniqueDates.add(dateString);
                });
                totalWorkoutsElem.textContent = uniqueDates.size;
            }
            
            // 2. Тренировки в этом месяце
            const thisMonthElem = document.getElementById('this-month');
            if (thisMonthElem) {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const thisMonthWorkouts = workouts.filter(workout => {
                    const workoutDate = new Date(workout.date);
                    return workoutDate.getMonth() === currentMonth && 
                           workoutDate.getFullYear() === currentYear &&
                           workout.exerciseCategory !== 'Другое';
                });
                const uniqueThisMonthDates = new Set();
                thisMonthWorkouts.forEach(workout => {
                    const date = new Date(workout.date);
                    const dateString = formatDateForComparison(date);
                    uniqueThisMonthDates.add(dateString);
                });
                thisMonthElem.textContent = uniqueThisMonthDates.size;
            }
            
            // 3. Сумма километров в кардио
            const totalDistanceElem = document.getElementById('total-distance');
            if (totalDistanceElem) {
                const cardioWorkouts = workouts.filter(w => 
                    w.exerciseCategory === 'Кардио' && 
                    w.distance && 
                    w.exerciseCategory !== 'Другое'
                );
                const totalDistance = cardioWorkouts.reduce((sum, workout) => sum + (workout.distance || 0), 0);
                totalDistanceElem.textContent = totalDistance.toFixed(1);
            }
            
            // 4-6. Лучшие результаты
            const workoutsByDateAndCategory = {};
            workouts
                .filter(w => w.exerciseCategory !== 'Другое' && w.exerciseCategory !== 'Кардио' && w.weight && w.reps && w.sets)
                .forEach(workout => {
                    const date = workout.date;
                    const category = workout.exerciseCategory;
                    const score = workout.weight * workout.reps * workout.sets;
                    if (!workoutsByDateAndCategory[date]) workoutsByDateAndCategory[date] = {};
                    if (!workoutsByDateAndCategory[date][category]) workoutsByDateAndCategory[date][category] = 0;
                    workoutsByDateAndCategory[date][category] += score;
                });
            
            let bestArmsBack = { score: 0, date: null };
            let bestLegs = { score: 0, date: null };
            let bestChest = { score: 0, date: null };
            
            Object.keys(workoutsByDateAndCategory).forEach(date => {
                const categories = workoutsByDateAndCategory[date];
                if (categories['Руки и спина'] > bestArmsBack.score) bestArmsBack = { score: categories['Руки и спина'], date };
                if (categories['Ноги и ягодицы'] > bestLegs.score) bestLegs = { score: categories['Ноги и ягодицы'], date };
                if (categories['Грудь и пресс'] > bestChest.score) bestChest = { score: categories['Грудь и пресс'], date };
            });
            
            document.getElementById('best-arms-back').textContent = bestArmsBack.score.toFixed(0);
            document.getElementById('best-arms-back-date').textContent = bestArmsBack.date ? formatDateCompact(bestArmsBack.date) : '-';
            document.getElementById('best-legs').textContent = bestLegs.score.toFixed(0);
            document.getElementById('best-legs-date').textContent = bestLegs.date ? formatDateCompact(bestLegs.date) : '-';
            document.getElementById('best-chest').textContent = bestChest.score.toFixed(0);
            document.getElementById('best-chest-date').textContent = bestChest.date ? formatDateCompact(bestChest.date) : '-';
        }

        function updateAnalytics() {
            const exerciseId = parseInt(document.getElementById('analytics-exercise').value);
            const lastWorkoutContainer = document.getElementById('last-workout-container');
            
            if (!exerciseId) {
                document.getElementById('progress-chart').innerHTML = `
                    <div class="chart-placeholder">
                        <i class="fas fa-chart-line" style="font-size: 2em; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Выберите упражнение для отображения прогресса</p>
                    </div>
                `;
                if (lastWorkoutContainer) lastWorkoutContainer.style.display = 'none';
                return;
            }
            
            const exercise = exercises.find(e => e.id === exerciseId);
            if (!exercise) return;
            
            const exerciseWorkouts = workouts
                .filter(w => w.exerciseId === exerciseId)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (exerciseWorkouts.length === 0) {
                document.getElementById('progress-chart').innerHTML = `
                    <div class="chart-placeholder">
                        <i class="fas fa-chart-line" style="font-size: 2em; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Нет данных для выбранного упражнения</p>
                    </div>
                `;
                if (lastWorkoutContainer) lastWorkoutContainer.style.display = 'none';
                return;
            }
            
            if (lastWorkoutContainer) {
                lastWorkoutContainer.style.display = 'block';
                const lastWorkout = exerciseWorkouts[exerciseWorkouts.length - 1];
                if (exercise.category === 'Кардио') {
                    let lastWorkoutText = '';
                    if (lastWorkout.level) lastWorkoutText += `Уровень: ${lastWorkout.level}`;
                    if (lastWorkout.distance) lastWorkoutText += `, ${lastWorkout.distance} км`;
                    if (lastWorkout.time) lastWorkoutText += `, ${lastWorkout.time} мин`;
                    document.getElementById('last-workout-value').textContent = lastWorkoutText || '-';
                } else {
                    document.getElementById('last-workout-value').textContent = 
                        `${lastWorkout.weight} кг × ${lastWorkout.reps} / ${lastWorkout.sets}`;
                }
            }
            
            let metricValues = [];
            let dates = [];
            if (exercise.category === 'Кардио') {
                metricValues = exerciseWorkouts.map(w => w.level || 0);
            } else {
                metricValues = exerciseWorkouts.map(w => (w.weight || 0) * (w.reps || 0) * (w.sets || 0));
            }
            dates = exerciseWorkouts.map(w => formatDateCompact(w.date));
            
            const minValue = Math.min(...metricValues);
            const maxValue = Math.max(...metricValues);
            const range = maxValue - minValue || 1;
            const chartHeight = 150;
            const chartWidth = dates.length * 40;
            const padding = 20;
            
            let chartHtml = '<div style="width: 100%; height: 100%; position: relative;">';
            chartHtml += `<svg width="100%" height="100%" viewBox="0 0 ${Math.max(chartWidth, 300)} ${chartHeight + padding * 2}" style="overflow: visible;">`;
            chartHtml += `<line x1="${padding}" y1="${chartHeight + padding}" x2="${Math.max(chartWidth, 300) - padding}" y2="${chartHeight + padding}" stroke="#ccc" stroke-width="1"/>`;
            
            let pathData = '';
            metricValues.forEach((value, index) => {
                const x = padding + (index * 40);
                const y = padding + chartHeight - ((value - minValue) / range * chartHeight);
                if (index === 0) pathData = `M ${x} ${y}`; else pathData += ` L ${x} ${y}`;
            });
            chartHtml += `<path d="${pathData}" fill="none" stroke="#27ae60" stroke-width="2"/>`;
            
            metricValues.forEach((value, index) => {
                const x = padding + (index * 40);
                const y = padding + chartHeight - ((value - minValue) / range * chartHeight);
                chartHtml += `<circle cx="${x}" cy="${y}" r="4" fill="#27ae60"/>`;
                chartHtml += `<text x="${x}" y="${y - 10}" text-anchor="middle" font-size="10" fill="#27ae60">${value.toFixed(0)}</text>`;
                chartHtml += `<text x="${x}" y="${chartHeight + padding + 15}" text-anchor="middle" font-size="10" fill="#7f8c8d">${dates[index]}</text>`;
            });
            chartHtml += '</svg></div>';
            document.getElementById('progress-chart').innerHTML = chartHtml;
        }

        function createBackup() {
            try {
                const backupData = {
                    exercises: exercises,
                    workouts: workouts,
                    dayComments: dayComments,
                    backupDate: new Date().toISOString(),
                    version: '1.0'
                };
                localStorage.setItem('workoutDiaryBackupData', JSON.stringify(backupData));
                backupSettings.lastBackup = new Date().toISOString();
                backupSettings.reminderShown = true;
                localStorage.setItem('workoutDiaryBackup', JSON.stringify(backupSettings));
                updateBackupInfo();
                showNotification('Резервная копия создана успешно', 'success');
            } catch (error) {
                console.error('Ошибка при создании резервной копии:', error);
                showNotification('Ошибка при создании резервной копии', 'error');
            }
        }

        function restoreBackup() {
            try {
                const backupData = localStorage.getItem('workoutDiaryBackupData');
                if (!backupData) { showNotification('Резервная копия не найдена', 'error'); return; }
                if (!confirm('Восстановить данные из последней резервной копии? Текущие данные будут заменены.')) return;
                const data = JSON.parse(backupData);
                exercises = data.exercises || [];
                workouts = data.workouts || [];
                dayComments = data.dayComments || {};
                localStorage.setItem('workoutDiaryExercises', JSON.stringify(exercises));
                localStorage.setItem('workoutDiaryWorkouts', JSON.stringify(workouts));
                localStorage.setItem('workoutDiaryDayComments', JSON.stringify(dayComments));
                loadCategories();
                updateExerciseDropdown();
                updateAnalyticsDropdown();
                updateStats();
                renderCalendar();
                loadExerciseHistory();
                showNotification('Данные восстановлены успешно', 'success');
            } catch (error) {
                console.error('Ошибка при восстановлении данных:', error);
                showNotification('Ошибка при восстановлении данных', 'error');
            }
        }

        function updateBackupInfo() {
            const backupInfo = document.getElementById('backup-info');
            if (!backupInfo) return;
            if (backupSettings.lastBackup) {
                const lastBackupDate = new Date(backupSettings.lastBackup);
                const formattedDate = lastBackupDate.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                backupInfo.textContent = `Последнее резервное копирование: ${formattedDate}`;
            } else {
                backupInfo.textContent = 'Последнее резервное копирование: никогда';
            }
        }

        function checkBackupReminder() {
            if (backupSettings.lastBackup) {
                const lastBackupDate = new Date(backupSettings.lastBackup);
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                if (lastBackupDate < oneWeekAgo && !backupSettings.reminderShown) {
                    setTimeout(() => {
                        if (confirm('Прошла неделя с последнего резервного копирования. Создать резервную копию сейчас?')) {
                            createBackup();
                        } else {
                            backupSettings.reminderShown = true;
                            localStorage.setItem('workoutDiaryBackup', JSON.stringify(backupSettings));
                        }
                    }, 2000);
                }
            } else if (!backupSettings.reminderShown) {
                setTimeout(() => {
                    if (confirm('Рекомендуется создать резервную копию данных. Создать сейчас?')) {
                        createBackup();
                    } else {
                        backupSettings.reminderShown = true;
                        localStorage.setItem('workoutDiaryBackup', JSON.stringify(backupSettings));
                    }
                }, 2000);
            }
        }

        function showNotification(message, type = 'success') {
            document.querySelectorAll('.notification').forEach(n => n.remove());
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    </script>
</body>
</html>
